---
title: "Social Network Analytics HW3"
output: html_notebook
---

```{r}
library(igraph)
library(data.table)
library(readxl)
library(dplyr)
library(ggplot2)
library(plm)
library(pglm)
library(panelAR)


setwd("C:/zhp/Emory/Studies/Social Network Analytics/HW3")
```


# Data Import 
```{r}
district = fread("district_information.csv", head = TRUE)
border = fread("border_information.csv", head = TRUE)
rain = fread("rain_information.csv", head = TRUE)
rain <- as.data.frame(rain)
candidate = fread("new_parties_in_each_district_by_candidate.csv", head = TRUE)
```

# Question 1

## PART A

```{r}

# merge district info and rain info 
#district_rain <- merge(district, rain, by.x = c('district'), by.y = c('district'))
unique(rain$year)

# get the start year of each election period
election_start <- unique(district$year)
sort(election_start)

# group the periods and calculate sum of raw rainfall and average of SPI for each district in each period
rain_period<-rain %>%
  mutate(period = ifelse(year <= 1951, 1951,
                         ifelse(year <= 1957,1957,
                                ifelse(year <= 1962,1962, 
                                       ifelse(year <= 1967, 1967,
                                              ifelse(year <= 1971, 1971, 
                                                     ifelse(year <= 1977, 1977 ,
                                                            ifelse(year <= 1980, 1980, 
                                                                   ifelse(year<= 1984,1984,
                                                                          ifelse(year <= 1985, 1985,
                                                                                 ifelse(year<=1989,1989, 
                                                                                        ifelse(year<=1991, 1991,
                                                                                               ifelse(year <=1996,1996,ifelse(year <= 1998,1998,ifelse(year <= 1999, 1999, 2003)) )))))))))))))

rain_period$extreme <- (rain_period$spi > 1 ) | (rain_period$spi < (-1) )


#write.csv(rain_period, 'rain_period.csv')


rainfall_level <- rain_period %>%
  group_by(district, period) %>%
  summarize(raw_sum = sum(rain, na.rm = TRUE), 
            mean_SPI = mean(spi, na.rm = TRUE),
            extreme_num = sum(extreme , na.rm = TRUE )  )

district_rain <- merge(district, rainfall_level, by.x = c('district', 'year'), by.y = c('district', 'period'))



#write.csv(district_rain, 'rainfile.csv')

```


```{r}
# make plots for Adilabad
par(mfrow = c(2,2))


plot(as.matrix(district_rain[district_rain$district == 'Adilabad', 'raw_sum']),as.matrix(district_rain[district_rain$district == 'Adilabad', 'new_parties']), xlab = 'Level of Rainfall (Sum of Raw Rainfall)', ylab = 'Number of New Parties')


plot(as.matrix(district_rain[district_rain$district == 'Adilabad', 'mean_SPI']), as.matrix(district_rain[district_rain$district == 'Adilabad', 'new_parties']), xlab = 'Level of Rainfall (Mean of SPI)', ylab = 'Number of New Parties')
```


```{r}
par(mfrow = c(2,2))


plot(as.matrix(district_rain[district_rain$district == 'Ajmer', 'raw_sum']),as.matrix(district_rain[district_rain$district == 'Ajmer', 'new_parties']), xlab = 'Level of Rainfall (Sum of Raw Rainfall)', ylab = 'Number of New Parties')


plot(as.matrix(district_rain[district_rain$district == 'Ajmer', 'mean_SPI']), as.matrix(district_rain[district_rain$district == 'Ajmer', 'new_parties']), xlab = 'Level of Rainfall (Mean of SPI)', ylab = 'Number of New Parties')
```


```{r}
# plot using raw rainfall
par(mfrow = c(1,1))
ggplot(district_rain, aes(x = raw_sum, y = new_parties)) + geom_point()

```

```{r}
# plot using SPI
ggplot(district_rain, aes(x = mean_SPI, y = new_parties)) + geom_point()
```

## PART B

```{r}
# build network of districts
net <- graph.data.frame(border, directed = FALSE)
net <- simplify(net, remove.loops = TRUE)
#plot(net, vertex.label = NA, vertex.size = 2)
#net

# find the neighbors of each vertex
v <- V(net)
neighbors <- lapply(seq_along(v), function(i) neighbors(net, v[i])$name )

#set_vertex_attr(net, 'neighbors', index = v, neighbors)
#get_vertex_attr(net, 'neighbors')

raw_neighbors <- list()
spi_neighbors <- list()



for (i in 1:nrow(district_rain)) {
  if (district_rain[i,1] %in% v$name) {
    nb <- neighbors[[which(v$name == as.character(district_rain[i,1]), arr.ind = TRUE)]]
    nb_raw <- mean(as.matrix(district_rain[(district_rain$district %in% nb) & (district_rain$year == as.character(district_rain[i,2])), 'raw_sum'], na.rm = TRUE  ))
    raw_neighbors <- append(raw_neighbors, nb_raw)
    nb_spi <- mean(as.matrix(district_rain[(district_rain$district %in% nb) & (district_rain$year == as.character(district_rain[i,2])), 'mean_SPI'], na.rm = TRUE ))
    spi_neighbors <- append(spi_neighbors, nb_spi)
    
  }
  else {
    raw_neighbors <- append(raw_neighbors, NA)
    spi_neighbors <- append(spi_neighbors, NA)
    
  }
}

raw_neighbors <- unlist(raw_neighbors)
spi_neighbors <- unlist(spi_neighbors)

district_rain_lag_nb <- cbind(district_rain, raw_neighbors, spi_neighbors)

# get the mean number of floods/drougts that neighbors experienced
extreme_neighbors <- list()

for (i in 1:nrow(district_rain_lag_nb)) {
  if (district_rain_lag_nb[i,1] %in% v$name) {
    nb <- neighbors[[which(v$name == as.character(district_rain_lag_nb[i,1]), arr.ind = TRUE)]]
    nb_extreme <- mean(as.matrix(district_rain_lag_nb[(district_rain_lag_nb$district %in% nb) & (district_rain_lag_nb$year == as.character(district_rain_lag_nb[i,2])), 'extreme_num'], na.rm = TRUE  ))
    extreme_neighbors <- append(extreme_neighbors, nb_extreme)
  }
  else {
    extreme_neighbors <- append(extreme_neighbors, NA)
  }
}

extreme_neighbors <- unlist(extreme_neighbors)


district_rain_lag_nb <- cbind(district_rain_lag_nb, extreme_neighbors)



```




```{r}
# create lagged terms
district_rain_lag_nb[, raw_neighbors_lag:=c(NA, raw_neighbors[-.N]), by=district]
district_rain_lag_nb[, spi_neighbors_lag:=c(NA, spi_neighbors[-.N]), by=district]
district_rain_lag_nb[, raw_self_lag:=c(NA, raw_sum[-.N]), by=district]
district_rain_lag_nb[, spi_self_lag:=c(NA, mean_SPI[-.N]), by=district]
district_rain_lag_nb[ , num_years := year - shift(year), by = district] 
# take the lag of the mean number of floods/droughts that neighbors experienced
district_rain_lag_nb[, extreme_neighbors_lag:=c(NA, extreme_neighbors[-.N]), by=district]
# take the lag of the mean number of floods/droughts that itself experienced
district_rain_lag_nb[, extreme_num_lag:=c(NA, extreme_num[-.N]), by=district]

# we could calculate the years in the first election period, but lags do not have values for the first period for each district. So we don't have to fill in the values.

#write.csv(district_rain_lag_nb, 'district_rain_lag_nb.csv')



```

```{r}
# regression with raw rainfall
mod_raw <- plm(raw_sum ~ raw_neighbors_lag + raw_self_lag +num_years , district_rain_lag_nb, effect = "twoways", model = "within", index = "district")
summary(mod_raw)
```

```{r}
# regression with SPI
mod_spi <- plm(mean_SPI ~ spi_neighbors_lag + spi_self_lag + num_years, district_rain_lag_nb, effect = "twoways", model = "within", index = "district")
summary(mod_spi)
```

## PART C
```{r}
mod_raw_extreme <- pglm(raw_sum ~ extreme_neighbors_lag + extreme_num_lag + num_years, district_rain_lag_nb, effect = "twoways", model = "within", index = "district", family = 'poisson')
summary(mod_raw_extreme)


```

```{r}
#t <- district_rain_lag_nb[complete.cases(district_rain_lag_nb), ]

mod_spi_extreme <- plm(mean_SPI ~ extreme_neighbors_lag + extreme_num_lag + num_years, district_rain_lag_nb, effect = "twoways", model = "within", index = "district")
summary(mod_spi_extreme)


```

# Question 2
```{r}
district_rain_lag_nb <- as.data.frame(district_rain_lag_nb)



model_panel_extreme <- panelAR(new_parties ~ extreme_num + num_years + year  , , panelVar = 'district', timeVar = 'year', autoCorr = "psar1", panelCorrMethod = "phet", rho.na.rm = TRUE)
summary(model_panel_extreme)

```

# Question 3

```{r}
model_panel_extreme_neighbors <- panelAR(new_parties ~ extreme_num + num_years + extreme_neighbors_lag+year, as.data.frame(district_rain_lag_nb), panelVar = 'district', timeVar = 'year', autoCorr = "psar1", panelCorrMethod = "phet", rho.na.rm = TRUE)
summary(model_panel_extreme_neighbors)


```

# Question 4
## PART A
```{r}
# national scope
model_national <- panelAR(new_parties_national_scope ~ extreme_num + num_years + extreme_neighbors_lag+year, as.data.frame(district_rain_lag_nb), panelVar = 'district', timeVar = 'year', autoCorr = "psar1", panelCorrMethod = "phet", rho.na.rm = TRUE)
summary(model_national)
```


```{r}
# state scope
model_state <- panelAR(new_parties_state_scope ~ extreme_num + num_years + extreme_neighbors_lag+year, as.data.frame(district_rain_lag_nb), panelVar = 'district', timeVar = 'year', autoCorr = "psar1", panelCorrMethod = "phet", rho.na.rm = TRUE)
summary(model_state)
```

```{r}
# regional scope
model_regional <- panelAR(new_parties_regional_scope ~ extreme_num + num_years + extreme_neighbors_lag+year, as.data.frame(district_rain_lag_nb), panelVar = 'district', timeVar = 'year', autoCorr = "psar1", panelCorrMethod = "phet", rho.na.rm = TRUE)
summary(model_regional)
```


## PART B
```{r}
model_concentration <- panelAR(political_concentration ~ extreme_num + extreme_neighbors_lag+ num_years + year, as.data.frame(district_rain_lag_nb), panelVar = 'district', timeVar = 'year', autoCorr = "psar1", panelCorrMethod = "phet", rho.na.rm = TRUE)
summary(model_concentration)

```
The Herfindahl index, the sum of the squares of the market shares of different groups, is an accurate measure of concentration. Specifically, higher Herfindahl index indicates lower competition and higher market power. In the case of election, higher Herfindahl index indicates higher political concentration.

# Question 5
```{r}

# for each row in the candidate file that denotes the name of the new party at each election period in each district, we calculate whether the new party has appeared in previous elections in the neighboring districts

history_list <- list()

for (i in 1:nrow(candidate)) {
  if (candidate[i,1] %in% v$name) {
    nb <- neighbors[[which(v$name == as.character(candidate[i,1]), arr.ind = TRUE)]]
    history <- candidate[i,5] %in% candidate[(candidate$district %in% nb) & (candidate$year < as.character(candidate[i,3])) ,]$party_name
    history_list <- append(history_list, history)
  }
  else {
    history_list <- append(history_list, NA)
  }
}

history_list <- unlist(history_list)
sum(history_list, na.rm = TRUE)




candidate_history <- cbind(candidate, history_list)

all <- merge(district_rain_lag_nb, candidate_history, by.x = c('district', 'year'), by.y = c('district', 'year'))
write.csv(all, 'all.csv')


```


```{r}

party_history <- all %>%
  group_by(district, year) %>%
  summarize(appear_num = sum(history_list, na.rm = TRUE) )

# join the number of appearance of the party in previous elections of neighbors with district_rain_lag_nb
all_join <- merge(district_rain_lag_nb, party_history, by.x = c('district', 'year'), by.y = c('district', 'year'))

# calculate the fraction of new parties that appeared in previous elections of neighbors
all_join <- all_join %>%
  mutate(appear_fract = appear_num/new_parties)

```

```{r}
# new political parties being founded in a district that have contested an election in a neighboring districtin any previous election period
model_contest <- panelAR(appear_num ~ extreme_num + extreme_neighbors_lag+ num_years + year, as.data.frame(all_join), panelVar = 'district', timeVar = 'year', autoCorr = "psar1", panelCorrMethod = "phet", rho.na.rm = TRUE)
summary(model_contest)
```

```{r}
# new political parties being founded in a district that have not contested an election in a neighboring district in any previous election period
model_noncontest <- panelAR((new_parties-appear_num) ~ extreme_num + extreme_neighbors_lag+ num_years + year, as.data.frame(all_join), panelVar = 'district', timeVar = 'year', autoCorr = "psar1", panelCorrMethod = "phet", rho.na.rm = TRUE)
summary(model_noncontest)
```


